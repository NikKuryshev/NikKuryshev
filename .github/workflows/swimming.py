import requests
import json
import asyncio
import os
from telegram import Bot
from telegram.error import TelegramError

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
filename = 'last_week_results.json'
access_token = os.environ['ACCESS_TOKEN']
club_id = '1426803'
headers = {'Authorization': f'Bearer {access_token}'}
telegram_bot_token = os.environ['TELEGRAM_BOT_TOKEN']
chat_id = 50820587

def load_past_week_activities(filename):
    """–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—à–ª–æ–π –Ω–µ–¥–µ–ª–∏ –∏–∑ —Ñ–∞–π–ª–∞."""
    try:
        with open(filename, 'r') as f:
            return json.load(f)
    except FileNotFoundError:
        return []

def save_current_week_activities(filename, data):
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–∞–π–ª. –£–∫–∞–∂–µ–º, —á—Ç–æ –∏—Å—Ç–æ—á–Ω–∏–∫ - Strava."""
    data_with_source = [{'data': act, 'source': 'Strava'} for act in data]
    with open(filename, 'w') as f:
        json.dump(data_with_source, f, ensure_ascii=False, indent=4)

def calculate_distances(activities):
    """–í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å—É–º–º–∞—Ä–Ω—ã—Ö —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞ –∏–∑ –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤."""
    result = {}
    for act in activities:
        source = act.get("source", "")
        athlete_info = {}
        
        # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∞
        if source == "Strava":
            athlete_info = act.get("data", {}).get("athlete", {})
            distance = act.get("data", {}).get("distance", 0)
        elif source == "Telegram":
            athlete_info = act.get("athlete", {})
            distance = act.get("distance", 0)
        
        athlete_name = athlete_info.get("firstname", "Unknown") + " " + athlete_info.get("lastname", "")
        result[athlete_name] = result.get(athlete_name, 0) + distance
    return result

async def send_message_to_telegram(bot_token, chat_id, text, delay_seconds):
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram."""
    print(f"–°–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ {delay_seconds / 3600:.2f} —á–∞—Å–æ–≤...")
    await asyncio.sleep(delay_seconds)
    bot = Bot(token=bot_token)
    try:
        await bot.send_message(chat_id=chat_id, text=text, parse_mode='Markdown')
        print("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –¢–µ–ª–µ–≥—Ä–∞–º!")
    except TelegramError as e:
        print(f"‚ùå Telegram API error: {e}")

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—à–ª–æ–π –Ω–µ–¥–µ–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
past_week_activities = load_past_week_activities(filename)

# –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —ç—Ç–æ–π –Ω–µ–¥–µ–ª–∏ –∏–∑ Strava API
response = requests.get(f'https://www.strava.com/api/v3/clubs/{club_id}/activities', headers=headers)

if response.status_code == 200:
    api_response = response.json()
    print("‚úÖ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—É—á–µ–Ω—ã, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:", len(api_response))
else:
    print(f"‚ùå Strava API –æ—à–∏–±–∫–∞: {response.status_code}")
    api_response = []

# –ü–æ–¥—Å—á–µ—Ç –∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
# –ú—ã –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –≤ –ø—Ä–æ—à–ª—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Ç–æ–∂–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
last_week_distances = calculate_distances(past_week_activities)
# –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏ –∫ –Ω–æ–≤–æ–º—É –≤–∏–¥—É
current_week_distances = calculate_distances([{'data': act, 'source': 'Strava'} for act in api_response])

# –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω–∏—Ü—É
difference = {}
for athlete in current_week_distances:
    prev_distance = last_week_distances.get(athlete, 0)
    current_distance = current_week_distances[athlete]
    difference[athlete] = current_distance - prev_distance

sorted_difference = sorted(
    [(athlete, diff) for athlete, diff in difference.items() if diff > 0],
    key=lambda x: x[1], reverse=True
)

# –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram
message = "üèÜ *–†–µ–π—Ç–∏–Ω–≥ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–æ–≤ –∑–∞ –Ω–µ–¥–µ–ª—é* üèÉ‚Äç‚ôÇÔ∏è\n\n"
if sorted_difference:
    for i, (name, diff_distance) in enumerate(sorted_difference, 1):
        message += f"{i}. {name} ‚Äî {diff_distance / 1000:.1f} –∫–º\n"
else:
    message += "–ü—Ä–∏—Ä–æ—Å—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∑–∞ —Ç–µ–∫—É—â—É—é –Ω–µ–¥–µ–ª—é –Ω–µ—Ç ü§∑‚Äç‚ôÇÔ∏è"

message += "\n–•–æ—Ä–æ—à–µ–π –≤—Å–µ–º –Ω–µ–¥–µ–ª–∏ üö¥‚Äç‚ôÄÔ∏èüèÖ"

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
save_current_week_activities(filename, api_response)

# –ó–∞–ø—É—Å–∫ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram
asyncio.run(send_message_to_telegram(telegram_bot_token, chat_id, message, delay_seconds=10))
